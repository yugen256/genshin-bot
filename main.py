import discord
from discord.ext import commands
import random
import os

ROULETTE_CHANNEL_ID = 1382250609486598164

print("✅ ファイルは実行された！")

intents = discord.Intents.default()
intents.message_content = True
bot = commands.Bot(command_prefix="", intents=intents)

# 設定状態
area_boss_enabled = False
all_boss_enabled = True
bind_count = 1

# --- 敵データ ---
aBosses = [
    "急凍樹", "爆炎樹", "無想の岩", "無想の風", "無想の雷", "無想の氷", "無想の炎", "無想の水", "無想の草",
    "純粋精霊", "エンシェントヴィシャップ", "魔偶剣鬼", "恒常からくり陣営", "雷音権限", "半永久統制マトリクス", "黄金王獣",
    "遺跡サーペント", "マッシュラプトル", "迅電樹", "兆載永劫ドレイク", "アビサルヴィシャップの群れ", "風触ウェネト",
    "深罪の浸礼者", "鉄甲熔炎帝王", "氷風組曲(コッペリアの葬送)", "氷風組曲(コペリウスの劫罰)", "千年真珠の海駿",
    "実験用フィールド生成装置", "水形タルパ", "山隠れの猊獣", "魔像レガトゥス", "暴君・金焔のクク竜", "山の王・貪食のユムカ竜",
    "秘源機兵機巧デバイス", "深遠なるミミックパピラ", "迷える霊覚の修験者", "輝ける溶岩の龍像", "秘源機兵・統御デバイス",
    "集光の幻月蝶", "ボコボコダック", "霜夜の空を巡る霊主"
]

wBosses = [
    "アンドリアス", "公子", "淑女", "若蛇龍王", "雷電将軍", "散兵", "アペプ", "呑星の鯨", "召使",
    "蝕まれし源焔の主", "扉に通ずる対局"
]

nChars = [
    "湖辺のヴィヴィアン", "湖辺のニニアン", "自立スーパーコンピューティング型力場生成装置", "イゾルト", "スネージヴナのディアンナラ",
    "リアム", "ロッキー・アヴィルドセン", "赤璋巡岳府君・移即＆天虜", "シネアス", "バラチコ", "コシーホ", "波のジャプー",
    "異色三連星・シドレンコ＆ノモンコノフ＆ヴァシリ", "リライ", "銅の錠", "鉄爪＆戦羊", "ピーク", "微末",
    "最後のテノチズトク人", "シグルド", "カニ皇帝", "ラスコルニコフ"
]

# 使用済み敵の履歴
used_enemies = {"エリアボス": [], "週ボス": [], "地方伝説": []}

# --- 縛りデータ ---
categories = {
    "元素系": [
        "炎元素キャラクター", "水元素キャラクター", "草元素キャラクター", "風元素キャラクター", "岩元素キャラクター",
        "雷元素キャラクター", "氷元素キャラクター", "交差の護り(元素すべてバラバラ)", "必ず2元素(炎・水)",
        "必ず2元素(炎・雷)", "必ず2元素(炎・岩)", "必ず2元素(炎・風)", "必ず2元素(炎・氷)", "必ず2元素(炎・草)",
        "必ず2元素(水・雷)", "必ず2元素(水・岩)", "必ず2元素(水・風)", "必ず2元素(水・氷)", "必ず2元素(水・草)",
        "必ず2元素(雷・岩)", "必ず2元素(雷・風)", "必ず2元素(雷・氷)", "必ず2元素(雷・草)", "必ず2元素(氷・風)",
        "必ず2元素(氷・岩)", "必ず2元素(氷・草)", "必ず2元素(風・岩)", "必ず2元素(岩・草)", "必ず2元素(風・草)",
        "岩・草・風", "敵が所持する元素耐性の元素"
    ],
    "元素反応系": [
        "溶解反応", "燃焼反応", "開花系反応(月反応含む)", "開花系反応(月反応含まない)", "蒸発反応", "凍結反応",
         "感電反応(月反応含む)", "感電反応(月反応含まない)", "超電導反応","激化反応", "過負荷反応", "結晶反応", "拡散反応",
        "元素反応禁止"

    ],
    "国・地域系": [
        "モンドキャラクター", "璃月キャラクター", "稲妻キャラクター", "スメールキャラクター", "フォンテーヌキャラクター",
        "ナタキャラクター", "ナド・クライキャラクター", "全て異なる国のキャラクター"
    ],
    "武器種系": [
        "片手剣キャラクター", "両手剣キャラクター", "法器キャラクター", "弓キャラクター", "長柄武器キャラクター",
        "イベント武器(無ければ星3以下の武器)", "必ず武器種2種類(片手剣・両手剣)", "必ず武器種2種類(片手剣・弓)",
        "必ず武器種2種類(片手剣・長柄武器)", "必ず武器種2種類(片手剣・法器)", "必ず武器種2種類(法器・両手剣)",
        "必ず武器種2種類(法器・弓)", "必ず武器種2種類(法器・長柄武器)", "必ず武器種2種類(両手剣・弓)",
        "必ず武器種2種類(両手剣・長柄武器)", "必ず武器種2種類(弓・長柄武器)", "全て異なる武器種のキャラクター", "鍛造武器"
    ],
    "性別・外見系": [
        "高身長キャラクター", "中身長キャラクター", "低身長キャラクター", "女性キャラクター", "男性キャラクター",
        "角や触覚、動物の耳や尻尾があるキャラクター", "帽子かメガネ、ゴーグルを頭につけているキャラクター",
        "メッシュ・グラデーションがあるキャラクター", "同じ目の色のキャラクター", "寒色系の瞳", "暖色系の瞳", "白・黒系の瞳"
    ],
    "星・実装・復刻系": [
        "星4", "星5", "恒常星5", "初実装から復刻していないキャラクター", "復刻や実装がver.1のキャラクター",
        "復刻や実装がver.2のキャラクター", "復刻や実装がver.3のキャラクター", "復刻や実装がver.4のキャラクター",
        "復刻や実装がver.5のキャラクター", "復刻や実装がLunaのキャラクター", "復刻回数1回~3回", "復刻回数4回~6回",
        "復刻回数7回以上", "復刻がver.1のキャラクター", "復刻がver.2のキャラクター", "復刻がver.3のキャラクター",
        "復刻がver.4のキャラクター", "復刻がver.5のキャラクター", "復刻がLunaのキャラクター",
        "集録祈願に実装されたことのあるキャラクター", "ver.1初実装キャラクター", "ver.2初実装キャラクター",
        "ver.3初実装キャラクター", "ver.4初実装キャラクター", "ver.5初実装キャラクター", "Luna初実装キャラクター",
        "所持している範囲で最新バージョンのキャラクター", "入手順先頭(凸を含むかは自由)"
    ],
    "誕生日系": [
        "誕生日が1~3月", "誕生日が4~6月", "誕生日が7~9月", "誕生日が10~12月",
        "誕生日が偶数日のキャラクター", "誕生日が奇数日のキャラクター"
    ],
    "名前・文字系": [
        "名前の頭文字がア行", "名前の頭文字がカ行", "名前の頭文字がサ行", "名前の頭文字がタ行", "名前の頭文字がナ行",
        "名前の頭文字がハ行", "名前の頭文字がマ・ヤ・ラ・ワ行", "名前の頭文字が母音ア", "名前の頭文字が母音イ",
        "名前の頭文字が母音ウ", "名前の頭文字が母音エ", "名前の頭文字が母音オ", "名前に濁点・半濁点が含まれていないキャラクター",
        "名前に濁点・半濁点が含まれているキャラクター", "拗音・促音・伸ばし棒が名前に含まれるキャラクター",
        "拗音・促音・伸ばし棒が名前に含まれていないキャラクター", "武器名カタカナ無し", "キャラ名カタカナ無し", "武器名カタカナ有り",
        "キャラ名カタカナ有り"
    ],
    "聖遺物系": [
        "モンドの聖遺物(セット効果)", "モンドの聖遺物(自由枠含む)", "璃月の聖遺物(セット効果)", "璃月の聖遺物(自由枠含む)",
        "稲妻の聖遺物(セット効果)", "稲妻の聖遺物(自由枠含む)", "スメールの聖遺物(セット効果)", "スメールの聖遺物(自由枠含む)",
        "フォンテーヌの聖遺物(セット効果)", "フォンテーヌの聖遺物(自由枠含む)", "ナタの聖遺物(セット効果)",
        "ナタの聖遺物(自由枠含む)", "ナド・クライの聖遺物(セット効果)", "ナド・クライの聖遺物(自由枠含む)", "ダメバフ杯禁止",
        "セット効果で会心率が上昇する聖遺物", "セット効果で特定の元素のバフが入る聖遺物", "聖遺物使用禁止(セット効果が無くても不可)",
        "聖遺物2・4セット効果禁止(つけるだけは可)", "聖遺物4セット効果禁止(2セット効果は可)"
    ],
    "天賦系": [
        "天賦の素材がトワリン", "天賦の素材がアンドリアス", "天賦の素材が公子", "天賦の素材が淑女", "天賦の素材が若蛇龍王",
        "天賦の素材が雷電将軍", "天賦の素材が残兵", "天賦の素材がアぺプ", "天賦の素材が呑星の鯨", "天賦の素材が召使",
        "天賦の素材が蝕まれし源焔の主", "天賦の素材が扉に通ずる対局", "天賦本曜日が月・木", "天賦本の曜日が火・金",
        "天賦本の曜日が水・土", "天賦本がモンド", "天賦本が璃月", "天賦本が稲妻", "天賦本がスメール", "天賦本がフォンテーヌ",
        "天賦本がナタ", "天賦本がナド・クライ", "元素爆発40族", "元素爆発60族", "元素爆発80族",
        "元素爆発50・70・90族・戦意・蛇の狡知", "元素爆発禁止", "元素爆発クールタイム中キャラクター切り替え禁止"
    ],
    "ステータス・戦闘系": [
        "飛び道具禁止{例：ナヒーダの元素スキル長押しは禁止(単押しならOK)}", "一回の攻撃で15,000以上禁止(元素反応含む)",
        "一回の攻撃で15,000以上禁止(元素反応含まない)", "会心率40%以下(一時的な効果を含む)",
        "会心ダメージ100%以下(一時的な効果を含む)", "HP15000未満(一時的な効果を含む)",
        "HP30000以上(一時的な効果を含む)", "攻撃力2200以上(一時的な効果を含む)", "攻撃力1500以下(一時的な効果を含む)",
        "防御力1500以上のキャラクター(一時的な効果を含む)", "会心率40%以下(一時的な効果を含まない)",
        "会心ダメージ100%以下(一時的な効果を含まない)", "HP15000未満(一時的な効果を含まない)",
        "HP30000以上(一時的な効果を含まない)", "攻撃力2200以上(一時的な効果を含まない)",
        "攻撃力1500以下(一時的な効果を含まない)", "防御力1500以上のキャラクター(一時的な効果を含まない)", "元素熟知800以上",
        "元素熟知150以下", "元素チャージ効率250%以上", "元素チャージ効率150%以下", "ヒーラー(自己回復)",
        "ヒーラー(自己回復を含む)", "ヒーラー(自己回復を含まない)", "中断耐性持ち", "フィールドを出せるキャラクター",
        "サポートキャラクター禁止(シールド・回復・バフ等禁止)", "召喚物を出せるキャラクター",
        "シールドor中断耐性を所持しているキャラクター", "移動系・スタミナ系能力持ち", "ノーダメージ(自己被ダメージはセーフ)",
        "ノーダメージ(自己被ダメージもアウト)"
    ],
    "素材系": [
        "ボス突破素材がモンドのキャラクター", "ボス突破素材が璃月のキャラクター", "ボス突破素材が稲妻のキャラクター",
        "ボス突破素材がスメールのキャラクター", "ボス突破素材がフォンテーヌのキャラクター", "ボス突破素材がナタのキャラクター",
        "ボス突破素材がナド・クライのキャラクター", "ボス突破素材が地下マップのキャラクター", "特産品突破素材がモンドのキャラクター",
        "特産品突破素材が璃月のキャラクター", "特産品突破素材が稲妻のキャラクター", "特産品突破素材がスメールのキャラクター",
        "特産品突破素材がフォンテーヌのキャラクター", "特産品突破素材がナタのキャラクター", "特産品突破素材がナド・クライのキャラクター",
        "特産品の種が存在する突破素材のキャラクター", "特産品の種が存在しない突破素材のキャラクター"
    ],
    "料理・その他系": [
        "オリジナル料理のレアリティ☆4", "オリジナル料理のレアリティ☆3", "オリジナル料理のレアリティ☆2,☆1",
        "オリジナル料理の効果：回復", "オリジナル料理の効果：防御系", "オリジナル料理の効果：攻撃系", "合成・鍛造・調度品の固有天賦",
        "衣装を複数持っているキャラクター(一時的な衣装変化を含まない)", "衣装を複数持っているキャラクター(一時的な衣装変化を含む)",
        "期間限定エリアに登場したことあるキャラクター", "過去に外部コラボをしたキャラクター"
    ],
    "特殊・雑多系": [
        "推し", "旅人・ドール", "純粋な人間", "過去に配布があったキャラクター", "協調性丸投げ(自己中編成)",
        "深境螺旋の最後に攻略した層で使用したキャラクター禁止", "Lv.70まで(いなければ旅人・ドール)",
        "全ての天賦Lv.5以下のキャラクター(いなければ旅人・ドール)", "メインUI非表示", "無凸(いなければ旅人・ドール)",
        "1~2凸(いなければ旅人・ドール)", "3~4凸(いなければ旅人・ドール)", "5~完凸(いなければ旅人・ドール)", "制限時間5分"
    ]
}
used_restrictions = []

# ===== 関数群 =====

def get_unique_random_item(list_data, used_list):
    available = [x for x in list_data if x not in used_list]
    if not available:
        return None
    choice = random.choice(available)
    used_list.append(choice)
    return choice


def get_available_enemy_types():
    available = []
    if area_boss_enabled and len(used_enemies["エリアボス"]) < len(aBosses):
        available.append(("エリアボス", aBosses))
    if len(used_enemies["週ボス"]) < len(wBosses):
        available.append(("週ボス", wBosses))
    if len(used_enemies["地方伝説"]) < len(nChars):
        available.append(("地方伝説", nChars))
    return available


def reset_all():
    global used_enemies, used_restrictions
    used_enemies = {"エリアボス": [], "週ボス": [], "地方伝説": []}
    used_restrictions = []


# ===== イベント =====

@bot.event
async def on_ready():
    print(f"✅ {bot.user} としてログインしました。")
    channel = bot.get_channel(ROULETTE_CHANNEL_ID)
    if channel:
        await channel.send(
            "🎮 **原神縛りルーレットBotへようこそ！**\n"
            "主なコマンド：\n"
            "- `/BIND 数字`：縛り数を設定（0〜5）\n"
            "- `/AREABOSS ON/OFF`：エリアボス含めるか\n"
            "- `/BOSS ON/OFF`：敵をランダム選択\n"
            "- `/ENTER`：ルーレット実行\n"
            "- `/RESET`：履歴をリセット（縛り・敵ともに復活）"
        )


@bot.event
async def on_message(message):
    global area_boss_enabled, all_boss_enabled, bind_count

    if message.author == bot.user or message.channel.id != ROULETTE_CHANNEL_ID:
        return

    content = message.content.strip().upper()

    if content.startswith("/AREABOSS "):
        area_boss_enabled = (content.split(" ")[1] == "ON")
        await message.channel.send(f"✅ エリアボスを含める: {area_boss_enabled}")

    elif content.startswith("/BOSS "):
        all_boss_enabled = (content.split(" ")[1] == "ON")
        await message.channel.send(f"✅ 敵ランダム選択: {all_boss_enabled}")

    elif content.startswith("/BIND "):
        try:
            num = int(content.split(" ")[1])
            if 0 <= num <= 5:
                bind_count = num
                await message.channel.send(f"✅ 縛り数を {bind_count} に設定しました。")
            else:
                await message.channel.send("⚠️ 縛り数は 0〜5 の間で指定してください。")
        except ValueError:
            await message.channel.send("⚠️ 数字を入力してください。")

    elif content == "/RESET":
        reset_all()
        await message.channel.send("🔄 **履歴をリセットしました！**（全ての縛り・敵候補が再び抽選対象に戻ります）")

    elif content == "/ENTER":
        result = []

        # ===== 縛り生成 =====
        if bind_count > 0:
            result.append("🎲 **縛り内容：**")
            for i in range(bind_count):
                cat_name = random.choice(list(categories.keys()))
                item = get_unique_random_item(categories[cat_name], used_restrictions)
                if item:
                    result.append(f"{i+1}. [{cat_name}] {item}")
                else:
                    result.append(f"{i+1}. [{cat_name}] 候補が尽きました")
        else:
            result.append("🎲 **縛りなし**")

        # ===== 敵抽選 =====
        if all_boss_enabled:
            available_types = get_available_enemy_types()
            if not available_types:
                result.append("👹 **敵候補がすべて尽きました！**")
            else:
                boss_type, boss_list = random.choice(available_types)
                boss = get_unique_random_item(boss_list, used_enemies[boss_type])
                result.append(f"👹 **敵：** {boss_type} - {boss}")
        else:
            result.append("👹 **敵なし**")

        await message.channel.send("\n".join(result))


# ===== 起動 =====
try:
    print("🔧 Discordに接続中...")
    bot.run(os.environ['TOKEN'])
except Exception as e:
    print("❌ 起動時エラー：", e)
